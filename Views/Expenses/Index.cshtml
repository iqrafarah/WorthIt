@model List<WorthIt.Models.ExpenseItemViewModel>

@{
    ViewData["Title"] = "Expenses";
}

<div class="text-center">
    <div class="expenses-summary">
        <span class="text-foreground-color"> Spent this month</span>
        <h1 class="display-4 price-title price my-3">
            @{
                decimal monthTotal = 0m;
                if (Model != null && Model.Any())
                {
                    monthTotal = Model
                    .Where(e => e.Expense.Date.Month == DateTime.Now.Month && e.Expense.Date.Year == DateTime.Now.Year)
                    .Sum(e => e.Expense.Amount);
                }
            }
            $@((float)monthTotal)
        </h1>
    </div>

    <section class="expenses-list">
        @{
            var today = DateTime.Today;

            var monthExpenses = Model?
            .Where(e => e.Expense.Date.Year == today.Year
            && e.Expense.Date.Month == today.Month)
            .OrderByDescending(e => e.Expense.Date)
            .ToList()
            ?? new List<WorthIt.Models.ExpenseItemViewModel>();
        }

        @if (monthExpenses.Any())
        {
            // Group by date (day)
            var groupedByDate = monthExpenses
            .GroupBy(e => e.Expense.Date.Date)
            .OrderByDescending(g => g.Key); // newest day first

            foreach (var dayGroup in groupedByDate)
            {
                var date = dayGroup.Key;
                var label = date == today
                ? "Today"
                : date == today.AddDays(-1)
                ? "Yesterday"
                : date.ToString("dddd dd MMM"); // e.g. "Monday 18 Nov"
                decimal dayTotal = dayGroup.Sum(x => x.Expense.Amount);

                <div class="expense-header d-flex justify-content-between align-items-center my-5">
                    <span class="expense-title">@label</span>
                    <span class="expense-monthly-amount">
                        $@((float)dayTotal)
                    </span>
                </div>

                @* All expenses for that specific day *@
                foreach (var viewModel in dayGroup)
                {
                    @await Html.PartialAsync("_ExpenseItem", viewModel)
                }
            }
        }
        else
        {
            <p class="text-center text-muted">No expenses recorded yet for this month.</p>
            <a asp-action="AddExpense" class="btn btn-primary">Add Expense</a>
        }
    </section>
</div>