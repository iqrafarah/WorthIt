@{
    ViewData["Title"] = "Summary";
}

@model List<WorthIt.Models.ExpenseItemViewModel>

<div class="py-4 analytics-summary">

    <div class="expenses-summary">
        <h1 class="display-4 price-title price my-3">
            @(Model.Sum(e => e.Expense?.Amount ?? 0m).ToString("C"))
        </h1>
        <span class="text-foreground-color"> Total Spent this month</span>
    </div>

    @await Html.PartialAsync("_Graph")

    <div class="expenses-summary mt-5">

        @{
            var groupedByCategory = Model
            .GroupBy(e => new { e.Category.CategoryName, e.Category.CategoryIcon })
            .ToList();
        }

        <section class="expenses-list">

            @foreach (var group in groupedByCategory)
            {
                var categoryName = group.Key.CategoryName ?? "Unknown";
                var categoryIcon = group.Key.CategoryIcon ?? "";
                var entryCount = group.Count();

                // --- Hour/minute calculation ---
                string timeText = "";

                var anyWithUser = group.FirstOrDefault(x =>
                x.User != null &&
                x.User.HourlyWage > 0 &&
                x.Expense != null);

                if (anyWithUser != null)
                {
                    var hourly = anyWithUser.User.HourlyWage;

                    var totalAmount = group
                    .Where(x => x.Expense != null)
                    .Sum(x => x.Expense.Amount);

                    decimal hours = totalAmount / hourly;

                    if (hours >= 1)
                    {
                        timeText = $"{hours:0.#}h";
                    }
                    else
                    {
                        var minutes = hours * 60;
                        timeText = $"{minutes:0} min";
                    }
                }

                <div class="expense-item">
                    <div class="expense-item d-flex justify-content-between align-items-center my-3">

                        <div class="d-flex align-items-center gap-3">
                            <div
                                class="expense-icon bg-primary d-flex flex-column align-items-center text-black rounded-circle">
                                @categoryIcon
                            </div>

                            <div class="d-flex flex-column">
                                <span class="expense-name text-black text-start">
                                    @categoryName
                                </span>

                                <span class="expense-date text-start">
                                    @(entryCount == 1 ? $"{entryCount} entry" : $"{entryCount} entries")
                                </span>
                            </div>
                        </div>

                        <div class="hour-cost">
                            @if (!string.IsNullOrEmpty(timeText))
                            {
                                <span title="Total time spent">@timeText</span>
                            }
                        </div>

                    </div>
                </div>
            }

        </section>
    </div>
</div>