@using System.Globalization
@{
    ViewData["Title"] = "Summary";
}

@using System.Globalization
@model List<WorthIt.Models.ExpenseItemViewModel>

@{
    var today = DateTime.Today;

    // All expenses for THIS month
    var monthExpenses = Model
    .Where(e => e.Expense != null &&
    e.Expense.Date.Year == today.Year &&
    e.Expense.Date.Month == today.Month)
    .ToList();

    // Total spent this month
    var totalSpentThisMonth = monthExpenses.Sum(e => e.Expense.Amount);

    // Group by category for the list + “Most Entry”
    var groupedByCategory = monthExpenses
    .Where(e => e.Category != null)
    .GroupBy(e => new { e.Category.CategoryName, e.Category.CategoryIcon })
    .ToList();

    // Highest spent DAY this month
    var highestDay = monthExpenses
    .GroupBy(e => e.Expense.Date.Date)
    .Select(g => new
    {
        Date = g.Key,
        Total = g.Sum(x => x.Expense.Amount)
    })
    .OrderByDescending(x => x.Total)
    .FirstOrDefault();

    // Category with MOST entries this month (tie-breaker: higher total)
    var mostEntryCategory = groupedByCategory
    .Select(g => new
    {
        g.Key.CategoryName,
        g.Key.CategoryIcon,
        Count = g.Count(),
        Total = g.Sum(x => x.Expense != null ? x.Expense.Amount : 0m)
    })
    .OrderByDescending(x => x.Count)
    .ThenByDescending(x => x.Total)
    .FirstOrDefault();
}

<div class="py-4 analytics-summary">

    <div class="expenses-summary">
        <h1 class="display-4 price-title price my-3">
            @totalSpentThisMonth.ToString("C")
        </h1>
        <span class="text-foreground-color"> Total Spent this month</span>
    </div>

    <div class="expenses-summary mt-5">

        <section class="expenses-list">

            @* Bar chart *@
            @await Html.PartialAsync("_Graph", Model)

            @* HIGHEST SPENT CARD (dynamic) *@
            <div class="analytics-item rounded-3 d-flex justify-content-between align-items-center my-3">
                <div class="d-flex align-items-center gap-3">
                    <div
                        class="expense-icon bg-primary d-flex flex-column align-items-center gap-y-2 text-black rounded-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20"
                            height="20" class="size-5">
                            <path fill-rule="evenodd"
                                d="M12.577 4.878a.75.75 0 0 1 .919-.53l4.78 1.281a.75.75 0 0 1 .531.919l-1.281 4.78a.75.75 0 0 1-1.449-.387l.81-3.022a19.407 19.407 0 0 0-5.594 5.203.75.75 0 0 1-1.139.093L7 10.06l-4.72 4.72a.75.75 0 0 1-1.06-1.061l5.25-5.25a.75.75 0 0 1 1.06 0l3.074 3.073a20.923 20.923 0 0 1 5.545-4.931l-3.042-.815a.75.75 0 0 1-.53-.919Z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="d-flex flex-column">
                        <span class="expense-name text-black text-500 text-start">
                            Highest Spent
                        </span>
                        <span class="expense-date text-start small">
                            @if (highestDay != null)
                            {
                                @highestDay.Date.ToString("ddd MMM dd yyyy")
                            }
                            else
                            {
                                @:No data yet
                            }
                        </span>
                    </div>
                </div>
                <span class="price-amount">
                    @(highestDay != null ? highestDay.Total.ToString("C") : "-")
                </span>
            </div>
            @* MOST ENTRY CARD (dynamic) *@
            <div class="mb-4 analytics-item rounded-3 d-flex justify-content-between align-items-center my-3">
                <div class="d-flex align-items-center gap-3">
                    <div
                        class="expense-icon bg-primary d-flex flex-column align-items-center gap-y-2 text-black rounded-circle">

                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="#000" width="20" height="20" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6Z" />
                        </svg>
                    </div>
                    <div class="d-flex flex-column">
                        <span class="expense-name text-black text-500 text-start">
                            Most Entry
                        </span>
                        <span class="expense-date text-start small">
                            @if (mostEntryCategory != null)
                            {
                                @($"{mostEntryCategory.Count} on ")
                                @Html.Raw(mostEntryCategory.CategoryIcon)
                                @($" {mostEntryCategory.CategoryName}")
                            }
                            else
                            {
                                @:No entries yet
                            }
                        </span>
                    </div>
                </div>
                <span class="price-amount">
                    @(mostEntryCategory != null ? mostEntryCategory.Total.ToString("C") : "-")
                </span>
            </div>

            @* CATEGORY LIST (still per this month) *@
            @foreach (var group in groupedByCategory)
            {
                var categoryName = group.Key.CategoryName ?? "Unknown";
                var categoryIcon = group.Key.CategoryIcon ?? "";
                var entryCount = group.Count();

                string timeText = "";

                var anyWithUser = group.FirstOrDefault(x =>
                x.User != null &&
                x.User.HourlyWage > 0 &&
                x.Expense != null);

                if (anyWithUser != null)
                {
                    var hourly = anyWithUser.User.HourlyWage;

                    var totalAmount = group
                    .Where(x => x.Expense != null)
                    .Sum(x => x.Expense.Amount);

                    decimal hours = totalAmount / hourly;

                    if (hours >= 1)
                    {
                        var hoursString = hours.ToString("0.#", CultureInfo.InvariantCulture);
                        timeText = $"{hoursString}uur";
                    }
                    else
                    {
                        var minutes = hours * 60;
                        var minutesString = minutes.ToString("0.#", CultureInfo.InvariantCulture);
                        timeText = $"{minutesString} min";
                    }
                }

                <div class="expense-item">
                    <div class="expense-item d-flex justify-content-between align-items-center my-3">
                        <div class="d-flex align-items-center gap-3">
                            <div
                                class="expense-icon bg-primary d-flex flex-column align-items-center text-black rounded-circle">
                                @categoryIcon
                            </div>

                            <div class="d-flex flex-column">
                                <span class="expense-name text-black text-start">
                                    @categoryName
                                </span>

                                <span class="expense-date text-start">
                                    @(entryCount == 1 ? $"{entryCount} entry" : $"{entryCount} entries")
                                </span>
                            </div>
                        </div>

                        <div class="hour-cost">
                            @if (!string.IsNullOrEmpty(timeText))
                            {
                                <span title="Total time spent">@timeText</span>
                            }
                        </div>
                    </div>
                </div>
            }

        </section>
    </div>
</div>